/*
 * Copyright (c) 2015, WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License./
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
function getAreaMark(a,b){var c={type:"area",from:{data:a.title},properties:{update:{x:{scale:"x",field:b.names[a.x]},y:{scale:"y",field:b.names[a.y]},y2:{scale:"y",value:0},fill:{value:"steelblue"},strokeWidth:{value:2},fillOpacity:{value:1}},hover:{fillOpacity:{value:.5}}}};return c}function getBarMark(a,b){var c={type:"rect",from:{data:a.title},properties:{update:{x:{scale:"x",field:b.names[a.x]},width:{scale:"x",band:!0,offset:-1},y:{scale:"y",field:b.names[a.y]},y2:{scale:"y",value:0},fill:{value:"steelblue"},fillOpacity:{value:1}},hover:{fillOpacity:{value:.5}}}};return c}function getLineMark(a,b){var c;return c=-1!=a.color?{type:"group",from:{data:a.title,transform:[{type:"facet",groupby:[b.names[a.color]]}]},marks:[{type:"line",properties:{update:{x:{scale:"x",field:b.names[a.x]},y:{scale:"y",field:b.names[a.y]},stroke:{scale:"color",field:b.names[a.color]},strokeWidth:{value:2},strokeOpacity:{value:1}},hover:{strokeOpacity:{value:.5}}}}]}:{type:"line",from:{data:a.title},properties:{update:{x:{scale:"x",field:b.names[a.x]},y:{scale:"y",field:b.names[a.y]},stroke:{value:"steelblue"},strokeWidth:{value:2},strokeOpacity:{value:1}},hover:{strokeOpacity:{value:.5}}}}}function setupData(a,b){for(var c=[],d=0;d<a.length;d++){for(var e={},f=0;f<b.columns.length;f++)e[b.columns[f]]=a[d][b.columns[f]];c.push(e)}var g=d3.select("tbody").selectAll("tr").data(c,function(a){return a[b.key]}),h=g.enter().append("tr").selectAll("td").data(function(a){return d3.map(a).values()}).enter().append("td");h.append("span");var i=g.selectAll("td").style({padding:"0px 10px 0px 10px"}).data(function(a){return d3.map(a).entries()}).attr("class",function(a){return a.key});if(i.select("span").text(function(a){return a.value}),-1!=b.maxLength&&d3.select("tbody").selectAll("tr").data().length>b.maxLength){var j=d3.select("tbody").selectAll("tr").data().slice(d3.select("tbody").selectAll("tr").data().length-b.maxLength,b.maxLength);d3.select("tbody").selectAll("tr").data(j,function(a){return a}).remove()}}function checkConfig(a,b){return null==a.title&&(a.title="table"),null==a.xTitle&&(a.xTitle=a.x),null==a.yTitle&&(a.yTitle=a.y),null==a.colorScale&&(a.colorScale="category10"),null==a.grid&&(a.grid=!0),null==a.zero&&(a.zero=!1),null==a.color?a.color=-1:a.color=b.names.indexOf(a.color),null==a.maxLength&&(a.maxLength=-1),null==a.padding&&(a.padding={top:30,left:50,bottom:100,right:100}),a.x=b.names.indexOf(a.x),a.y=b.names.indexOf(a.y),a}function buildTable(a){var b={};return b.metadata=a[0].metadata,b.values=buildData(a[0].data,a[0].metadata),b}function buildData(a,b){for(chartData=[],i=0;i<a.length;i++){var c={};for(x=0;x<b.names.length;x++)c[b.names[x]]=a[i][x];chartData.push(c)}return chartData}var area=function(a,b){this.metadata=a[0].metadata;var c=[];this.spec={},b=checkConfig(b,this.metadata),this.config=b,a[0].name=b.title;var d={name:"x",type:this.metadata.types[b.x],range:"width",zero:b.zero,domain:{data:b.title,field:this.metadata.names[b.x]}},e={name:"y",type:this.metadata.types[b.y],range:"height",zero:"false",domain:{data:b.title,field:this.metadata.names[b.y]}},f=[d,e],g=[{type:"x",scale:"x",grid:b.grid,title:b.xTitle},{type:"y",scale:"y",grid:b.grid,title:b.yTitle}];c.push(getAreaMark(b,this.metadata)),this.spec.width=b.width,this.spec.height=b.height,this.spec.axes=g,this.spec.data=a,this.spec.scales=f,this.spec.padding=b.padding,this.spec.marks=c};area.prototype.draw=function(a){var b=function(b){this.view=b({el:a}).update()}.bind(this);vg.parse.spec(this.spec,b)},area.prototype.insert=function(a){if(-1!=this.config.maxLength&&this.config.maxLength<this.view.data(this.config.title).values().length+a.length){var b=function(a){return a[this.metadata.names[this.config.x]]==c}.bind(this);for(i=0;i<a.length;i++){var c=this.view.data(this.config.title).values()[i][this.metadata.names[this.config.x]];this.view.data(this.config.title).remove(b)}}this.view.data(this.config.title).insert(a),this.view.update()},area.prototype.getSpec=function(){return this.spec};var bar=function(a,b){this.metadata=a[0].metadata;var c=[];this.spec={},b=checkConfig(b,this.metadata),this.config=b,a[0].name=b.title;var d={name:"x",type:"ordinal",range:"width",domain:{data:b.title,field:this.metadata.names[b.x]}},e={name:"y",type:this.metadata.types[b.y],range:"height",domain:{data:b.title,field:this.metadata.names[b.y]}},f=[d,e],g=[{type:"x",scale:"x",grid:b.grid,title:b.xTitle},{type:"y",scale:"y",grid:b.grid,title:b.yTitle}];c.push(getBarMark(b,this.metadata)),this.spec.width=b.width,this.spec.height=b.height,this.spec.axes=g,this.spec.data=a,this.spec.scales=f,this.spec.padding=b.padding,this.spec.marks=c};bar.prototype.draw=function(a){var b=function(b){this.view=b({el:a}).update()}.bind(this);vg.parse.spec(this.spec,b)},bar.prototype.insert=function(a){var b=!0,c=this.metadata.names[this.config.x],d=this.metadata.names[this.config.y];for(i=0;i<a.length;i++)this.view.data(this.config.title).update(function(b){return b[c]==a[i][c]},d,function(c){return b=!1,a[i][d]});if(b){if(-1!=this.config.maxLength&&this.config.maxLength<this.view.data(this.config.title).values().length+a.length){var e,f=function(a){return a[c]==e};for(i=0;i<a.length;i++)e=this.view.data(this.config.title).values()[i][c],this.view.data(this.config.title).remove(f)}this.view.data(this.config.title).insert(a)}this.view.update({duration:200})},bar.prototype.getSpec=function(){return this.spec};var vizg=function(a,b){a=buildTable(a),1==b.charts.length&&(b.type=b.charts[0].type,b.y=b.charts[0].y,b.color=b.charts[0].color,this.chart=new window[b.type]([a],b))};vizg.prototype.draw=function(a){this.chart.draw(a)},vizg.prototype.insert=function(a){this.chart.insert(buildData(a,this.chart.metadata))},vizg.prototype.getSpec=function(){return this.chart.getSpec()};var line=function(a,b){this.metadata=a[0].metadata;var c=[];this.spec={},b=checkConfig(b,this.metadata),this.config=b,a[0].name=b.title;var d={name:"x",type:this.metadata.types[b.x],range:"width",zero:b.zero,domain:{data:b.title,field:this.metadata.names[b.x]}},e={name:"y",type:this.metadata.types[b.y],range:"height",zero:b.zero,domain:{data:b.title,field:this.metadata.names[b.y]}},f=[d,e];if(-1!=b.color){var g={name:"color",type:"ordinal",domain:{data:b.title,field:this.metadata.names[b.color]},range:b.colorScale};f.push(g)}var h=[{type:"x",scale:"x",grid:b.grid,title:b.xTitle},{type:"y",scale:"y",grid:b.grid,title:b.yTitle}];if(c.push(getLineMark(b,this.metadata)),-1!=b.color){var i="Legend";"table"!=b.title&&(i=b.title);var j=[{fill:"color",title:"Legend",offset:0,properties:{symbols:{fillOpacity:{value:.5},stroke:{value:"transparent"}}}}];this.spec.legends=j}this.spec.width=b.width,this.spec.height=b.height,this.spec.axes=h,this.spec.data=a,this.spec.scales=f,this.spec.padding=b.padding,this.spec.marks=c};line.prototype.draw=function(a){var b=function(b){this.view=b({el:a}).update()}.bind(this);vg.parse.spec(this.spec,b)},line.prototype.insert=function(a){if(-1!=this.config.maxLength&&this.config.maxLength<this.view.data(this.config.title).values().length+a.length){var b=function(a){return a[this.metadata.names[this.config.x]]==c}.bind(this);for(i=0;i<a.length;i++){var c=this.view.data(this.config.title).values()[i][this.metadata.names[this.config.x]];this.view.data(this.config.title).remove(b)}}this.view.data(this.config.title).insert(a),this.view.update()},line.prototype.getSpec=function(){return this.spec};var number=function(a,b){this.metadata=a[0].metadata,this.data=a[0].values;this.spec={},b=checkConfig(b,this.metadata),this.config=b,a[0].name=b.title};number.prototype.draw=function(a){a=a.replace("#","");var b=a+"Content",c="";null!=this.data&&0!=this.data.length&&(c=this.data[this.data.length-1][this.metadata.names[this.config.x]]);var d="<p style='padding: 0px 0px 0px 20px;'>"+this.config.title+"</p><br/><p style='font-size:60;padding: 0px 0px 0px 20px;' id='"+b+"'>"+c+"</p>";document.getElementById(a).innerHTML=d,this.view=b},number.prototype.insert=function(a){document.getElementById(this.view).innerHTML=a[a.length-1][this.metadata.names[this.config.x]]};var table=function(a,b){this.metadata=a[0].metadata,this.data=a[0].values;this.spec={},b=checkConfig(b,this.metadata),this.config=b,a[0].name=b.title};table.prototype.draw=function(a){var b=d3.select(a).append("table").attr("border","2px");b.append("thead").attr("align","center").append("tr").selectAll("th").data(this.config.columns).enter().append("th").text(function(a){return a}),b.append("tbody"),setupData(this.data,this.config),b.selectAll("thead th").text(function(a){return a.charAt(0).toUpperCase()+a.substr(1)})},table.prototype.insert=function(a){setupData(a,this.config)};